modules:
  - name: route53
    type: terraform
    source: github.com/shalb/cluster.dev//terraform/aws/route53?ref=new-reconciler
    inputs:
      region: {{ .variables.region }}
      cluster_name: {{ .name }}
      cluster_domain: {{ .variables.domain }}
      zone_delegation: {{ if eq .variables.domain "cluster.dev" }}true{{ else }}false{{ end }}
  - name: vpc
    type: terraform
    source: github.com/shalb/cluster.dev//terraform/aws/vpc?ref=new-reconciler
    inputs:
      region: {{ .variables.region }}
      cluster_name: {{ .name }}
      availability_zones: {{ insertYAML .variables.azs }}
  - name: k3s
    type: terraform
    source: github.com/shalb/terraform-aws-k3s.git
    inputs:
      cluster_name: {{ .name }}
      domain: {{ remoteState "this.route53.domain" }}
      k3s_version: "1.19.3+k3s1"
      key_name: "arti-key"
      public_subnets: {{ remoteState "this.vpc.public_subnets" }}
      region: {{ .variables.region }}
      s3_bucket: {{ .variables.bucket }}
      master_node_count: 1